{% extends 'base/base.html' %}

{% load django_bootstrap_breadcrumbs %}

{% block title %} Controle {% endblock %}
{% block action %}
<div class="row">
	<div class="col-md-12 text-right mb-2">
		{% if not controle %}
		<a href="{% url 'projeto_controle' convenio.id %}" class="btn btn-sm btn-agiliza"> <i class="fas fa-plus-circle"></i> Criar Controle </a>
		{% endif %}
	</div>
</div>
{% endblock %}
{% block body %}
	{% block breadcrumbs %}
		{% breadcrumb_safe "<i class='fas fa-home'></i>" "/" %}
		{% breadcrumb " Convênios " "convenios" %}
		{% breadcrumb " Controle " "convenio_projeto_controle" convenio.id %}
		{% render_breadcrumbs %}
	{% endblock %}

	{% csrf_token %}

	<div class="row">
		<div class="col-md-12">

			{% if controle %}
			<table class="table table-bordered">
				<thead>
					<tr>
						<th>Orgão</th>
						<th>Projeto</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>{{ controle.orgao }}</td>
						<td>{{ controle.projeto.get_tipo_display }}</td>
					</tr>
				</tbody>
			</table>
			{% else %}
			<div class="alert alert-info mb-0">Nenhum controle criado!</div>
			<br>
			{% endif %}
			<table class="table table-bordered">
				<thead>
					<tr>
						<th>Item</th>
						<th>Opção</th>
						<th>Responsável</th>
						<th>Data Prevista</th>
						<th width="1%"></th>
						<!-- <th width="1%"></th> -->
					</tr>
				</thead>
				<tbody>
					{% for item in itens %}
					<tr>
						<td>{{ item.descricao }}</td>
						<td>{{ item.item_controle.alternativa|default:"" }}</td>
						<td>{{ item.item_controle.responsavel|default:"" }}</td>
						<td>{{ item.item_controle.data_prevista|date:"d/m/Y"|default:"" }}</td>
						<td class="p-1 text-center" style="vertical-align: middle;"><a href="javascript: void(0);" class="btn btn-sm btn-link" data-toggle="modal" data-target="#itemModal" data-item-id="{{ item.id }}" data-id="{{ item.item_controle.id|default:False }}"> <i class="fas fa-plus"></i> </a></td>
						<td class="p-1 text-center" style="vertical-align: middle;">
							{% if item.item_controle %}	
							<a href="javascript: void(0);" onclick="removerItemControle(this)" data-id="{{ item.id }}" class="btn btn-sm btn-link text-danger"><i class="fas fa-times"></i></a>
							{% endif %}
						</td>
					</tr>
					{% endfor %}
					
				</tbody>
			</table>
		</div>
	</div>

	<!-- Item Modal -->
	<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<form id="itemControleForm" class="form" onsubmit="submeterItemControle(this)">
				<div class="modal-header">
					<h5 class="modal-title" id="itemModalLabel">Item</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
						<input type="hidden" name="controle" value="{{ controle.id }}" id="id_controle" />
						<input type="hidden" name="item" id="id_item" />
						<div class="row">
							<div class="col-md-12">
								<label for="id_prefeitura">Opção</label>
								{{ projeto_controle_item_form.alternativa }}
							</div>
						</div>
						<div class="row">
							<div class="col-md-12">
								<label for="id_prefeitura">Responsável</label>
								{{ projeto_controle_item_form.responsavel }}
							</div>
						</div>
						<div class="row">
							<div class="col-md-12">
								<label for="id_prefeitura">Observações</label>
								{{ projeto_controle_item_form.observacoes }}
							</div>
						</div>
						<div class="row">
							<div class="col-md-12">
								<label for="id_prefeitura">Comentário</label>
								{{ projeto_controle_item_form.comentario }}
							</div>
						</div>
						<div class="row">
							<div class="col-md-12">
								<label for="id_prefeitura">Data Prevista</label>
								{{ projeto_controle_item_form.data_prevista }}
							</div>
						</div>
						<br>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal"> <i class="fas fa-times"></i> Cancelar </button>
					<button type="submit" class="btn btn-primary"> <i class="fas fa-plus-circle"></i> Salvar </button>
				</div>
				</form>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		let token = document.getElementsByName('csrfmiddlewaretoken')[0].value

		$('#itemModal').on('show.bs.modal', function (event) {
			var button = $(event.relatedTarget)
			var itemControleID = button.data('id')
			var itemID = button.data('item-id')
			console.log(itemControleID)
			console.log(itemID)
			var modal = $(this)
			modal.find('.modal-body input#id_item').val(itemID)
		})

		let submeterItemControle = (formulario) => {
			event.preventDefault()
			dados = new FormData(formulario)
			apiSubmeterDadosItemControle(dados)
		}

		let removerItemControle = (el) => {
			let id = el.dataset.id
			apiDeletarItemControle(id)
		}

		let apiSubmeterDadosItemControle = (dados) => {
			fetch(`/api/item/controle`, {
				method: 'POST',
				headers: {
					'X-CSRFToken': token
				},
				body: dados
			})
			.then(response => response.json())
			.then(data => {
				console.log('Success: ', data)
			})
			.catch(error => {
				console.log('Error: ', error)
			})
		}

		let apiDeletarItemControle = (id) => {
			fetch(`/api/item/controle/${id}`, {
				method: 'DELETE',
				headers: {
					'X-CSRFToken': token
				}
			})
			.then(response => console.log(response))
			.then(data => {
				console.log('Success: ', data)
			})
			.catch(error => {
				console.log('Error: ', error)
			})
		}
	</script>
{% endblock %}
