{% extends 'base/base.html' %}

{% load django_bootstrap_breadcrumbs %}

{% block title %} Elaboração de Projeto {% endblock %}
{% block action %}
<div class="row">
	<div class="col-md-12 text-right mb-2">
		{% if not controle %}
		<a href="{% url 'projeto_controle' convenio.id %}" class="btn btn-sm btn-link-agiliza px-3">CRIAR <i class="fas fa-plus"></i> </a>
		{% endif %}
	</div>
</div>
{% endblock %}
{% block body %}
	{% block breadcrumbs %}
		{% breadcrumb_safe "<i class='fas fa-home'></i>" "/" %}
		{% breadcrumb " Convênios " "convenios" %}
		{% breadcrumb " Elaboração de Projeto " "convenio_projeto_controle" convenio.id %}
		{% render_breadcrumbs %}
	{% endblock %}

	{% csrf_token %}

	<div class="row">
		<div class="col-md-12">

			{% if controle %}
			<table class="table table-bordered">
				<thead>
					<tr>
						<th>Orgão</th>
						<th>Projeto</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>{{ controle.orgao }}</td>
						<td>{{ controle.projeto.get_tipo_display }}</td>
					</tr>
				</tbody>
			</table>
			{% else %}
			<div class="alert alert-info mb-0">Nenhum projeto criado!</div>
			<br>
			{% endif %}
			<table class="table table-bordered table-hover">
				<thead>
					<tr>
						<th>Item</th>
						<th>Opção</th>
						<th>Responsável</th>
						<th>Data Prevista</th>
						<th width="1%"></th>
						<!-- <th width="1%"></th> -->
					</tr>
				</thead>
				<tbody>
					{% if itens %}
					{% for item in itens %}
					<tr class="item-controle">
						<td>
							<div class="descricao">{{ item.descricao }}</div>
							<div class="observacoes text-danger">{{ item.item_controle.observacoes }}</div>
						</td>
						<td class="alternativa">{{ item.item_controle.alternativa|default:"" }}</td>
						<td class="responsavel">{{ item.item_controle.responsavel|default:"" }}</td>
						<td class="data_prevista">{{ item.item_controle.data_prevista|date:"d/m/Y"|default:"" }}</td>
						<td class="submeter_item_controle p-1 text-center" style="vertical-align: middle;">
							{% if not item.item_controle.id %}
							<a href="javascript: void(0);" class="btn btn-sm btn-link botao_submeter_item_controle" data-posicao="{{ forloop.counter0 }}" data-item-id="{{ item.id }}" data-id="{{ item.item_controle.id|default:False }}" onclick="abrirItemModal(this)"><i class="fas fa-circle"></i></a>
							{% else %}
							<a href="javascript: void(0);" class="btn btn-sm btn-link text-success botao_submeter_item_controle" data-posicao="{{ forloop.counter0 }}" data-item-id="{{ item.id }}" data-id="{{ item.item_controle.id|default:False }}" onclick="abrirItemModal(this)"><i class="fas fa-check-circle"></i></a>
							{% endif %}
						</td>
						<td class="p-1 text-center remover" style="vertical-align: middle;">
							{% if item.item_controle %}	
							<a href="javascript: void(0);" class="btn btn-sm btn-link text-danger" data-posicao="{{ forloop.counter0 }}" data-item-id="{{ item.id }}" data-id="{{ item.item_controle.id }}" onclick="removerItemControle(this)"><i class="fas fa-times-circle"></i></a>
							{% endif %}
						</td>
					</tr>
					{% endfor %}
					{% endif %}
				</tbody>
			</table>
		</div>
	</div>

	<!-- Item Modal -->
	<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<form id="itemControleForm" class="form" onsubmit="submeterItemControle(this)">
				<div class="modal-header">
					<h5 class="modal-title" id="itemModalLabel">Item</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<input type="hidden" name="controle" value="{{ controle.id }}" id="id_controle" />
					<input type="hidden" name="item" id="id_item" />
					<div class="row">
						<div class="col-md-5 form-group">
							<label for="id_prefeitura">Opção</label>
							{{ projeto_controle_item_form.alternativa }}
						</div>
						<div class="col-md-3 form-group">
							<label for="id_prefeitura">Data Prevista</label>
							{{ projeto_controle_item_form.data_prevista }}
						</div>
						<div class="col-md-4 form-group">
							<label for="id_prefeitura">Responsável</label>
							{{ projeto_controle_item_form.responsavel }}
						</div>
					</div>
					<div class="row">
						<div class="col-md-12 form-group">
							<label for="id_prefeitura">Observações</label>
							{{ projeto_controle_item_form.observacoes }}
						</div>
					</div>
					<div class="row">
						<div class="col-md-12 form-group">
							<label for="id_prefeitura">Comentário</label>
							{{ projeto_controle_item_form.comentario }}
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="submit" class="btn btn-sm btn-primary px-3 py-1"> Salvar </button>
					<button type="button" class="btn btn-sm btn-secondary px-3 py-1" data-dismiss="modal"> Cancelar </button>
				</div>
				</form>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		let token = document.getElementsByName('csrfmiddlewaretoken')[0].value

		let abrirItemModal = (el) => {
			let posicao = pegarPosicaoItem(el)
			$('#itemModal').modal('show')
			document.getElementById('itemControleForm').reset();
			document.getElementById('itemControleForm').dataset.posicao = posicao
			if (el.dataset.id != 'False') {
				document.getElementById('itemControleForm').dataset.id = el.dataset.id
				apiCarregarFormularioItemControle(el.dataset.id)
			}
			document.getElementById('id_item').value = el.dataset.itemId
		}


		let submeterItemControle = (formulario) => {
			event.preventDefault()
			let posicao = formulario.dataset.posicao
			let id = formulario.dataset.id || false
			dados = new FormData(formulario)
			apiSubmeterDadosItemControle(dados, id, posicao)
		}

		let removerItemControle = (el) => {
			let id = el.dataset.id
			let item = el.dataset.itemId
			let posicao = el.dataset.posicao
			alertify.confirm(
				'Remover item', 
				'Tem certeza que deseja remover este item?', 
				function() { 
					apiDeletarItemControle(id, item, posicao)
				},
				function() { console.log('Não foi possível remover o item') })
				.set('labels', {ok: 'Sim', cancel: 'Não'})
		}

		function pegarMetodoSubmeter(id) {
			if (id) return { url: `/api/item/controle/${id}`, method: 'PUT' }
			return { url: `/api/item/controle`, method: 'POST' }
		}

		let apiSubmeterDadosItemControle = (dados, id, posicao = false) => {
			let requisicao = pegarMetodoSubmeter(id)

			fetch(requisicao.url, {
				method: requisicao.method,
				headers: {
					'X-CSRFToken': token
				},
				body: dados
			})
			.then(response => response.json())
			.then(data => {
				// console.log('Success: ', data)
				apiCarregarDadosItemControle(data.id, posicao)
				fecharItemModal()
			})
			.catch(error => console.log('Error: ', error)) }

		let apiCarregarDadosItemControle = (id, posicao = false) => {
			fetch(`/api/item/controle/${id}`, {
				method: 'GET',
				headers: {
					'X-CSRFToken': token
				}
			})
			.then(response => response.json())
			.then(data => {
				// console.log('Success: ', data)
				carregarItemControle(data, posicao)
			})
			.catch(error => console.log('Error: ', error)) }

		let apiCarregarFormularioItemControle = (id) => {
			fetch(`/api/item/controle/${id}`, {
				method: 'GET',
				headers: {
					'X-CSRFToken': token
				}
			})
			.then(response => response.json())
			.then(data => {
				// console.log('Success: ', data)
				carregarFormularioItemControle(data)
			})
			.catch(error => console.log('Error: ', error)) }

		let carregarFormularioItemControle = (item) => {
			console.log(item)
			document.getElementById('id_alternativa').value = item.alternativa.id
			document.getElementById('id_data_prevista').value = formatarData(item.data_prevista)
			document.getElementById('id_responsavel').value = item.responsavel.id
			document.getElementById('id_observacoes').value = item.observacoes
			document.getElementById('id_comentario').value = item.comentario
		}

		let carregarItemControle = (item, posicao = false) => {
			let alternativa = document.getElementsByClassName('alternativa')[posicao]
			let observacoes = document.getElementsByClassName('observacoes')[posicao]
			let responsavel = document.getElementsByClassName('responsavel')[posicao]
			let data_prevista = document.getElementsByClassName('data_prevista')[posicao]
			let remover = document.getElementsByClassName('remover')[posicao]
			let submeter = document.getElementsByClassName('submeter_item_controle')[posicao]
			alternativa.innerHTML = item.alternativa.descricao
			observacoes.innerHTML = item.observacoes
			responsavel.innerHTML = item.responsavel.nome
			data_prevista.innerHTML = formatarData(item.data_prevista)
			remover.innerHTML = `<a href='javascript: void(0);' onclick='removerItemControle(this)' data-posicao='${posicao}' data-item-id='${item.item}' data-id='${item.id}' class='btn btn-sm btn-link text-danger'><i class='fas fa-times-circle'></i></a>`
			submeter.innerHTML = `<a href='javascript: void(0);' class='btn btn-sm btn-link text-success submeter_item_controle' data-posicao='${posicao}' data-item-id='${item.item}' data-id='${item.id}' onclick='abrirItemModal(this)'><i class='fas fa-check-circle'></i></a>`
		}

		let deletarItemControle = (id, item, posicao = false) => {
			let alternativa = document.getElementsByClassName('alternativa')[posicao]
			let observacoes = document.getElementsByClassName('observacoes')[posicao]
			let responsavel = document.getElementsByClassName('responsavel')[posicao]
			let data_prevista = document.getElementsByClassName('data_prevista')[posicao]
			let remover = document.getElementsByClassName('remover')[posicao]
			let submeter = document.getElementsByClassName('submeter_item_controle')[posicao]
			alternativa.innerHTML = ''
			observacoes.innerHTML = ''
			responsavel.innerHTML = ''
			data_prevista.innerHTML = ''
			remover.innerHTML = ''
			submeter.innerHTML = `<a href='javascript: void(0);' class='btn btn-sm btn-link submeter_item_controle' data-posicao='${posicao}' data-item-id='${item}' data-id='False' onclick='abrirItemModal(this)'><i class='fas fa-circle'></i></a>`
		}

		let apiDeletarItemControle = (id, item, posicao = false) => {
			fetch(`/api/item/controle/${id}`, {
				method: 'DELETE',
				headers: {
					'X-CSRFToken': token
				}
			})
			.then(response => console.log(response))
			.then(data => {
				// console.log('Success: ', data)
				console.log(id, item, posicao)
				deletarItemControle(id, item, posicao)
			})
			.catch(error => console.log('Error: ', error)) }

		let fecharItemModal = () => {
			$('#itemModal').modal('hide')
		}

		function pegarPosicaoItem(item) {
			var lista = document.getElementsByClassName('botao_submeter_item_controle')
			lista = [].slice.call(lista)
			posicao = lista.indexOf(item)
			return posicao
		}

		function formatarData(data) {
			elemento = data.split('-')
			data = [elemento[2], elemento[1], elemento[0]]
			data = data.join('/')
			return data
		}
	</script>
{% endblock %}
