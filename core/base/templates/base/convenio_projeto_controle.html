{% extends 'base/base.html' %}

{% load django_bootstrap_breadcrumbs %}

{% block title %} Controle {% endblock %}
{% block action %}
<div class="row">
	<div class="col-md-12 text-right mb-2">
		{% if not controle %}
		<a href="{% url 'projeto_controle' convenio.id %}" class="btn btn-sm btn-agiliza"> <i class="fas fa-plus-circle"></i> Criar Controle </a>
		{% endif %}
		{% if controle %}
		<!-- <a href="{# url 'projeto_controle_item' controle.id #}" class="btn btn-sm btn-agiliza"> <i class="fas fa-plus-circle"></i> Adicionar Item </a> -->
		{% endif %}
	</div>
</div>
{% endblock %}
{% block body %}
	{% block breadcrumbs %}
		{% breadcrumb_safe "<i class='fas fa-home'></i>" "/" %}
		{% breadcrumb " Convênios " "convenios" %}
		{% breadcrumb " Controle " "convenio_projeto_controle" convenio.id %}
		{% render_breadcrumbs %}
	{% endblock %}

	{% csrf_token %}

	<div class="row">
		<div class="col-md-12">

			{% if controle %}
			<table class="table table-bordered">
				<thead>
					<tr>
						<th>Orgão</th>
						<th>Projeto</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>{{ controle.orgao }}</td>
						<td>{{ controle.projeto.get_tipo_display }}</td>
					</tr>
				</tbody>
			</table>
			{% else %}
			<div class="alert alert-info mb-0">Nenhum controle criado!</div>
			<br>
			{% endif %}
			<!-- <div class="row">
				<div class="col-md-12 mb-2 text-right">
					<a href="javascript: void(0);" class="btn btn-sm btn-agiliza" data-toggle="modal" data-target="#itemModal"><i class="fas fa-plus-circle"></i> Item</a>
				</div>
			</div> -->
			{% if itens %}
			<table class="table table-bordered">
				<thead>
					<tr>
						<th>Item</th>
						<th>Opção</th>
						<th>Responsável</th>
						<th>Data Prevista</th>
						<th class="p-1" width="1%" style="vertical-align: middle;"><a href="javascript: void(0);" class="btn btn-sm btn-link" data-toggle="modal" data-target="#itemModal"> <i class="fas fa-plus"></i> </a></th>
					</tr>
				</thead>
				<tbody>
					{% for item in itens %}
					<tr>
						<td>{{ item.item.descricao }}</td>
						<td>{{ item.alternativa }}</td>
						<td>{{ item.responsavel }}</td>
						<td>{{ item.data_prevista }}</td>
						<td class="text-center"><a href="javascript: void(0);" onclick="removerItemControle(this)" data-item-id="{{ item.id }}" class="text-danger"><i class="fas fa-times"></i></a></td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
			{% elif controle %}
			<div class="alert alert-info mb-0">Nenhum item adicionado!</div>
			{% endif %}
		</div>
	</div>

	<!-- Item Modal -->
	<div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<form id="itemControleForm" class="form" onsubmit="submeterItemControle(this)">
				<div class="modal-header">
					<h5 class="modal-title" id="itemModalLabel">Item</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
						<input type="hidden" name="controle" value="{{ controle.id }}" />
						<br />
						<div class="row">
							<div class="col-md-12">
								<label for="id_prefeitura">Item</label>
								{{ projeto_controle_item_form.item }}
							</div>
						</div>
						<div class="row">
							<div class="col-md-12">
								<label for="id_prefeitura">Opção</label>
								{{ projeto_controle_item_form.alternativa }}
							</div>
						</div>
						<div class="row">
							<div class="col-md-12">
								<label for="id_prefeitura">Responsável</label>
								{{ projeto_controle_item_form.responsavel }}
							</div>
						</div>
						<div class="row">
							<div class="col-md-12">
								<label for="id_prefeitura">Observações</label>
								{{ projeto_controle_item_form.observacoes }}
							</div>
						</div>
						<div class="row">
							<div class="col-md-12">
								<label for="id_prefeitura">Comentário</label>
								{{ projeto_controle_item_form.comentario }}
							</div>
						</div>
						<div class="row">
							<div class="col-md-12">
								<label for="id_prefeitura">Data Prevista</label>
								{{ projeto_controle_item_form.data_prevista }}
							</div>
						</div>
						<br>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
					<button type="submit" class="btn btn-primary"> <i class="fas fa-plus-circle"></i> </button>
				</div>
				</form>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		let token = document.getElementsByName('csrfmiddlewaretoken')[0].value

		let submeterItemControle = (formulario) => {
			event.preventDefault()
			dados = new FormData(formulario)
			apiSubmeterDadosItemControle(dados)
		}

		let removerItemControle = (el) => {
			let itemID = el.dataset.itemId
			apiDeletarItemControle(itemID)
		}

		let apiSubmeterDadosItemControle = (dados) => {
			fetch(`/api/item/controle`, {
				method: 'POST',
				headers: {
					'X-CSRFToken': token
				},
				body: dados
			})
			.then(response => response.json())
			.then(data => {
				console.log('Success: ', data)
			})
			.catch(error => {
				console.log('Error: ', error)
			})
		}

		let apiDeletarItemControle = (itemID) => {
			fetch(`/api/item/controle/${itemID}`, {
				method: 'DELETE',
				headers: {
					'X-CSRFToken': token
				}
			})
			.then(response => console.log(response))
			.then(data => {
				console.log('Success: ', data)
			})
			.catch(error => {
				console.log('Error: ', error)
			})
		}
	</script>
{% endblock %}
